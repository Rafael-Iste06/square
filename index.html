<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Square - Chat & Amis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where, getDocs, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        const firebaseConfig = {
        apiKey: "AIzaSyAHOsMHLpi0XNcb4rSMHA_ZJr1VkhnXebQ",
        authDomain: "messagerie-didi.firebaseapp.com",
        projectId: "messagerie-didi",
        storageBucket: "messagerie-didi.firebasestorage.app",
        messagingSenderId: "243037235936",
        appId: "1:243037235936:web:0b1313ae09cb7acb5b3e85",
        measurementId: "G-M2DETH5BWE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        createApp({
            data() {
                return {
                    user: null,
                    isLoginMode: true,
                    form: { email: '', password: '', username: '' },
                    searchUsername: '',
                    contacts: [], // Amis + Conversations actives
                    sentRequests: [],
                    pendingRequests: [], // Demandes re√ßues
                    selectedContact: null,
                    messages: [],
                    newMessage: '',
                    loading: false,
                    view: 'chats', // 'chats' ou 'requests',
                    showProfileModal: false, // Pour afficher/cacher l'√©dition
                    newDisplayName: '',
                    newPhotoURL: '',
                    searchContactTerm: '',
                    newBio: '',
                    showContactProfile: false,
                    showEmojiPicker: false
                }
            },
            computed: {
                filteredContacts() {
                    if (!this.searchContactTerm) return this.contacts;
                    const term = this.searchContactTerm.toLowerCase();
                    return this.contacts.filter(c => 
                        c.username.toLowerCase().includes(term)
                    );
                }
            },
            mounted() {
                onAuthStateChanged(auth, async (user) => {
                    this.user = user;
                    if (user) {
                        // R√©cup√©rer les donn√©es suppl√©mentaires (bio, etc.) dans Firestore
                        const userSnap = await getDocs(query(collection(db, "users"), where("uid", "==", user.uid)));
                        if (!userSnap.empty) {
                            const userData = userSnap.docs[0].data();
                            this.newBio = userData.bio || ''; // On remplit la variable pour la modale
                            this.newDisplayName = user.displayName || '';
                        }
                        this.listenToRequests();
                        this.listenToSentRequests(); // N'oublie pas d'ajouter cette m√©thode
                        this.listenToContacts();

                        // Mise √† jour du statut lors de la connexion
                        const userRef = doc(db, "users", user.uid);
                        await updateDoc(userRef, { status: 'online', lastSeen: serverTimestamp() });

                        // Optionnel : Passer en "offline" quand on ferme l'onglet (n√©cessite Realtime DB pour √™tre fiable)
                        window.addEventListener('beforeunload', () => {
                            updateDoc(userRef, { status: 'offline' });
                        });
                    }
                });
            },
            methods: {
                async handleAuth() {
                    this.loading = true;
                    try {
                        if (this.isLoginMode) {
                            await signInWithEmailAndPassword(auth, this.form.email, this.form.password);
                        } else {
                            const res = await createUserWithEmailAndPassword(auth, this.form.email, this.form.password);
                            const name = this.form.username.trim();
                            await updateProfile(res.user, { displayName: name });
                            await setDoc(doc(db, "users", res.user.uid), {
                                uid: res.user.uid,
                                username: name,
                                username_lowercase: name.toLowerCase()
                            });
                        }
                    } catch (e) { alert(e.message); } finally { this.loading = false; }
                },

                // Dans methods
                addEmoji(emoji) {
                    this.newMessage += emoji.native;
                    // Optionnel : fermer le picker apr√®s s√©lection
                    // this.showEmojiPicker = false; 
                },

                toggleEmojiPicker() {
                    this.showEmojiPicker = !this.showEmojiPicker;
                    if (this.showEmojiPicker) {
                        this.$nextTick(() => {
                            const container = document.getElementById('emoji-picker-container');
                            // On v√©rifie s'il n'existe pas d√©j√† pour √©viter les doublons
                            if (container && !container.firstChild) {
                                const pickerOptions = {
                                    onEmojiSelect: (emoji) => {
                                        this.newMessage += emoji.native;
                                    },
                                    theme: 'dark',
                                    locale: 'fr',
                                    set: 'native',
                                    perLine: 8,
                                    emojiSize: 18,
                                    // --- AJOUTEZ CES LIGNES ---
                                    previewPosition: 'none',     // Supprime le texte "Choisissez un emoji"
                                    navPosition: 'bottom',       // (Optionnel) D√©place les cat√©gories en bas
                                    searchPosition: 'sticky',    // Garde la recherche en haut
                                    // --------------------------
                                };
                                const picker = new EmojiMart.Picker(pickerOptions);
                                container.appendChild(picker);
                            }
                        });
                    }
                },

                // --- R√âACTIONS ---
                async toggleReaction(msg) {
                    const chatId = this.getChatId(this.user.uid, this.selectedContact.uid);
                    const msgRef = doc(db, "conversations", chatId, "messages", msg.id);
                    
                    // On initialise reactions comme un tableau s'il n'existe pas
                    let reactions = msg.reactions || [];
                    
                    if (reactions.includes(this.user.uid)) {
                        // Si j'ai d√©j√† r√©agi, je retire mon ID
                        reactions = reactions.filter(id => id !== this.user.uid);
                    } else {
                        // Sinon, j'ajoute mon ID
                        reactions.push(this.user.uid);
                    }

                    try {
                        await updateDoc(msgRef, { reactions: reactions });
                    } catch (e) {
                        console.error("Erreur r√©actions multiples:", e);
                    }
                },

                formatDate(timestamp) {
                    if (!timestamp) return "...";
                    const date = timestamp.toDate();
                    const now = new Date();
                    const diffInSeconds = Math.floor((now - date) / 1000);

                    if (diffInSeconds < 60) return "√Ä l'instant";
                    if (diffInSeconds < 3600) return `Il y a ${Math.floor(diffInSeconds / 60)} min`;
                    if (diffInSeconds < 86400) return `Il y a ${Math.floor(diffInSeconds / 3600)} h`;
                    return date.toLocaleDateString();
                },

                // --- GESTION DES AMIS ---
                async removeFriend(friendId) {
                    if (!confirm("Supprimer cet ami ?")) return;
                    // Supprime chez moi
                    await deleteDoc(doc(db, "users", this.user.uid, "contacts", friendId));
                    // Supprime chez l'autre
                    await deleteDoc(doc(db, "users", friendId, "contacts", this.user.uid));
                    this.selectedContact = null;
                },

                // --- GESTION DES DEMANDES ENVOY√âES ---
                listenToSentRequests() {
                    const q = query(collection(db, "requests"), where("fromId", "==", this.user.uid), where("status", "==", "pending"));
                    onSnapshot(q, (snap) => {
                        this.sentRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    });
                },

                async cancelRequest(reqId) {
                    await deleteDoc(doc(db, "requests", reqId));
                },

                // --- GESTION DES DEMANDES RE√áUES ---
                async rejectRequest(reqId) {
                    await deleteDoc(doc(db, "requests", reqId));
                },

                async updateUserSettings() {
                    this.loading = true;
                    try {
                        const userRef = doc(db, "users", this.user.uid);
                        const updates = {
                            username: this.newDisplayName || this.user.displayName,
                            username_lowercase: (this.newDisplayName || this.user.displayName).toLowerCase(),
                            avatar: this.newPhotoURL || this.user.photoURL,
                            bio: this.newBio // On enregistre la bio ici
                        };

                        // Mise √† jour Firestore
                        await updateDoc(userRef, updates);

                        // Mise √† jour Profil Auth
                        await updateProfile(auth.currentUser, {
                            displayName: updates.username,
                            photoURL: updates.avatar
                        });

                        this.showProfileModal = false;
                        alert("Profil et bio mis √† jour !");
                    } catch (e) {
                        alert("Erreur : " + e.message);
                    } finally {
                        this.loading = false;
                    }
                },

                // 1. SYSTEME DE DEMANDE D'AMI
                async sendFriendRequest() {
                    const name = this.searchUsername.trim().toLowerCase();
                    const q = query(collection(db, "users"), where("username_lowercase", "==", name));
                    const snap = await getDocs(q);
                    
                    if (snap.empty) return alert("Utilisateur introuvable");
                    const target = snap.docs[0].data();
                    
                    // Ajout de toName pour pouvoir l'afficher dans "Demandes envoy√©es"
                    await setDoc(doc(db, "requests", target.uid + "_" + this.user.uid), {
                        fromId: this.user.uid,
                        fromName: this.user.displayName,
                        toId: target.uid,
                        toName: target.username, // <--- On ajoute cette ligne
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert("Demande envoy√©e √† " + target.username);
                    this.searchUsername = '';
                },

                listenToRequests() {
                    const q = query(collection(db, "requests"), where("toId", "==", this.user.uid), where("status", "==", "pending"));
                    onSnapshot(q, (snap) => {
                        this.pendingRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    });
                },

                async acceptRequest(req) {
                    // 1. Ajouter l'ami mutuellement
                    const myFriendDoc = doc(db, "users", this.user.uid, "contacts", req.fromId);
                    const theirFriendDoc = doc(db, "users", req.fromId, "contacts", this.user.uid);
                    
                    await setDoc(myFriendDoc, { uid: req.fromId, username: req.fromName });
                    await setDoc(theirFriendDoc, { uid: this.user.uid, username: this.user.displayName });
                    
                    // 2. Supprimer la demande
                    await deleteDoc(doc(db, "requests", req.id));
                },

                // 2. LISTE DES CONTACTS (Amis + Conversations re√ßues)
                listenToContacts() {
                    // On √©coute les amis officiels
                    onSnapshot(collection(db, "users", this.user.uid, "contacts"), (snap) => {
                        this.contacts = snap.docs.map(d => d.data());
                    });
                },

                getChatId(uid1, uid2) {
                    return [uid1, uid2].sort().join("_");
                },

                async selectContact(contact) {
                    // 1. R√©cup√©rer les infos compl√®tes de l'ami (dont la bio)
                    const userSnap = await getDocs(query(collection(db, "users"), where("uid", "==", contact.uid)));
                    if (!userSnap.empty) {
                        this.selectedContact = { ...contact, ...userSnap.docs[0].data() };
                    } else {
                        this.selectedContact = contact;
                    }

                    // 2. Charger les messages (ton code existant)
                    const chatId = this.getChatId(this.user.uid, contact.uid);
                    const q = query(collection(db, "conversations", chatId, "messages"), orderBy("createdAt", "asc"));
                    
                    onSnapshot(q, (snap) => {
                        this.messages = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        this.scrollToBottom();
                    });
                },

                async sendMessage() {
                    if (!this.newMessage.trim() || !this.selectedContact) return;
                    const chatId = this.getChatId(this.user.uid, this.selectedContact.uid);
                    const text = this.newMessage;
                    this.newMessage = '';

                    // On cr√©e une r√©f√©rence pour g√©n√©rer un ID automatiquement
                    const msgRef = doc(collection(db, "conversations", chatId, "messages"));
                    await setDoc(msgRef, {
                        id: msgRef.id, // On stocke l'ID √† l'int√©rieur du message
                        text: text,
                        senderId: this.user.uid,
                        createdAt: serverTimestamp(),
                        edited: false // Indicateur de modification
                    });
                },

                // --- SUPPRESSION ---
                async deleteMessage(msgId) {
                    if (!confirm("Supprimer ce message ?")) return;
                    const chatId = this.getChatId(this.user.uid, this.selectedContact.uid);
                    await deleteDoc(doc(db, "conversations", chatId, "messages", msgId));
                },

                // --- MODIFICATION ---
                async editMessage(msg) {
                    const newText = prompt("Modifier le message :", msg.text);
                    if (newText === null || newText.trim() === "" || newText === msg.text) return;

                    const chatId = this.getChatId(this.user.uid, this.selectedContact.uid);
                    await updateDoc(doc(db, "conversations", chatId, "messages", msg.id), {
                        text: newText,
                        edited: true
                    });
                },

                scrollToBottom() {
                    setTimeout(() => { this.$refs.msgContainer.scrollTop = this.$refs.msgContainer.scrollHeight; }, 100);
                },

                logout() { signOut(auth).then(() => window.location.reload()); }
            }
        }).mount('#app');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@5.5.2/dist/browser.js"></script>
    <style>
        /* Positionnement et redimensionnement du clavier */
        #emoji-picker-container {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 1rem;
            z-index: 50;
            /* Vous pouvez remonter le scale √† 0.9 ou 1 si le retrait du texte a suffi */
            transform: scale(1); 
            transform-origin: bottom right;
        }
        /* Optionnel : rendre le picker plus compact via ses propres variables */
        em-emoji-picker {
            --em-button-size: 30px; /* Taille des boutons d'emojis */
            --em-id: emoji-mart;
            max-height: 350px;     /* Limite la hauteur totale */
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-0 md:p-6">
    <div id="app" class="w-full h-full max-w-6xl glass rounded-none md:rounded-[3rem] flex overflow-hidden shadow-2xl">
        
        <div v-if="!user" class="m-auto w-full max-w-sm p-10">
            <h1 class="text-4xl font-black mb-8 text-center italic">SQUARE.</h1>
            <div class="space-y-4">
                <input v-if="!isLoginMode" v-model="form.username" type="text" placeholder="Pseudo" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                <input v-model="form.email" type="email" placeholder="Email" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                <input v-model="form.password" type="password" placeholder="Mot de passe" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                <button @click="handleAuth" class="w-full bg-blue-600 py-4 rounded-2xl font-bold shadow-lg shadow-blue-900/40">
                    {{ isLoginMode ? 'Connexion' : 'Inscription' }}
                </button>
                <button @click="isLoginMode = !isLoginMode" class="w-full text-xs text-slate-500 underline">
                    {{ isLoginMode ? "Cr√©er un compte" : "D√©j√† inscrit ?" }}
                </button>
            </div>
        </div>

        <template v-else>
            <div class="w-80 border-r border-white/5 flex flex-col bg-black/20">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <span class="font-black italic text-xl">SQUARE.</span>
                        <div class="relative">
                            <button @click="view = 'requests'" class="p-2 hover:bg-white/10 rounded-full relative group">
                                <svg class="w-6 h-6 text-slate-400 group-hover:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                                <span v-if="pendingRequests.length" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[#0f172a]"></span>
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="searchUsername" @keyup.enter="sendFriendRequest" placeholder="Ajouter par pseudo..." class="flex-1 bg-white/5 border border-white/10 p-3 rounded-xl text-xs outline-none">
                        <button @click="sendFriendRequest" class="bg-blue-600 px-4 rounded-xl font-bold">+</button>
                    </div>
                </div>

                <div class="flex px-6 mb-4 gap-4 text-xs font-bold uppercase tracking-widest text-slate-500">
                    <button @click="view = 'chats'" :class="view === 'chats' ? 'text-blue-400 border-b-2 border-blue-400' : ''">Messages</button>
                    <button @click="view = 'requests'" :class="view === 'requests' ? 'text-blue-400 border-b-2 border-blue-400' : ''">Demandes ({{pendingRequests.length}})</button>
                </div>

                <div class="flex-1 overflow-y-auto px-3 space-y-2">
                    <div v-if="view === 'chats'" class="px-4 mb-3">
                        <div class="relative">
                            <input v-model="searchContactTerm" 
                                type="text" 
                                placeholder="Rechercher un ami..." 
                                class="w-full bg-white/5 border border-white/10 p-2 pl-8 rounded-xl text-[10px] outline-none focus:border-blue-500/50 transition">
                            <svg class="w-3 h-3 absolute left-3 top-2.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <template v-if="view === 'chats'">
                        <div v-for="c in filteredContacts" 
                            :key="c.uid"
                            @click="selectContact(c)"
                            :class="selectedContact?.uid === c.uid ? 'bg-blue-600 shadow-xl' : 'hover:bg-white/5'"
                            class="p-4 rounded-2xl cursor-pointer transition flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold">
                                {{ c.username[0] }}
                            </div>
                            <span class="font-bold">{{ c.username }}</span>
                        </div>
                    </template>

                    <template v-else>
                        <div class="mb-6">
                            <h3 class="text-[10px] font-black uppercase text-slate-500 mb-2 px-4">Re√ßues ({{pendingRequests.length}})</h3>
                            <div v-for="req in pendingRequests" :key="req.id" class="p-4 bg-white/5 rounded-2xl mb-2 flex flex-col gap-3">
                                <div class="flex justify-between items-start">
                                    <span class="text-xs font-bold">{{ req.fromName }}</span>
                                    <span class="text-[9px] text-slate-500">{{ formatDate(req.createdAt) }}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="acceptRequest(req)" class="flex-1 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600 hover:text-white p-2 rounded-lg transition flex justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </button>

                                    <button @click="rejectRequest(req.id)" class="flex-1 bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white p-2 rounded-lg transition flex justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-[10px] font-black uppercase text-slate-500 mb-2 px-4 italic">Mes envois ({{sentRequests.length}})</h3>
                            <div v-for="req in sentRequests" :key="req.id" class="p-4 bg-white/[0.02] border border-white/5 rounded-2xl mb-2 flex justify-between items-center">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-400">@{{ req.toName }}</span>
                                    <span class="text-[9px] text-slate-500 uppercase font-medium italic">
                                        Envoy√© {{ formatDate(req.createdAt) }}
                                    </span>
                                </div>
                                <button @click="cancelRequest(req.id)" class="text-[10px] text-red-400 font-bold hover:underline">Annuler</button>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="p-4 flex items-center gap-3 border-t border-white/5">
                    <div @click="showProfileModal = true" class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold cursor-pointer hover:ring-2 ring-blue-400 transition">
                        {{ user.displayName ? user.displayName[0] : '?' }}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-bold">{{ user.displayName }}</p>
                        <button @click="logout" class="text-[10px] text-slate-500 hover:text-red-400 uppercase font-black">D√©connexion</button>
                    </div>
                </div>

                <div v-if="showProfileModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div class="glass max-w-sm w-full p-8 rounded-[2rem] space-y-6">
                        <h2 class="text-2xl font-bold italic">Mon Profil</h2>
                        <div class="space-y-4">
                            <label class="block text-xs font-bold text-slate-400 uppercase">Nouveau Pseudo</label>
                            <input v-model="newDisplayName" type="text" :placeholder="user.displayName" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                            
                            <label class="block text-xs font-bold text-slate-400 uppercase">URL de l'avatar (Lien image)</label>
                            <input v-model="newPhotoURL" type="text" placeholder="https://..." class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                        </div>
                        <div class="space-y-4">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest">Ma Bio</label>
                            <textarea v-model="newBio" 
                                    placeholder="Parle-nous de toi..." 
                                    maxlength="160"
                                    class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 min-h-[100px] resize-none text-sm">
                            </textarea>
                            <div class="text-right text-[10px] text-slate-500">{{ newBio.length }}/160</div>
                        </div>
                        <div class="flex gap-3">
                            <button @click="showProfileModal = false" class="flex-1 py-4 text-slate-400 font-bold">Annuler</button>
                            <button @click="updateUserSettings" class="flex-1 bg-blue-600 py-4 rounded-2xl font-bold shadow-lg shadow-blue-900/40">Enregistrer</button>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="showContactProfile && selectedContact" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50 p-4">
                <div class="glass max-w-sm w-full rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/10">
                    <div class="h-24 bg-gradient-to-r from-blue-600 to-indigo-900"></div>
                    
                    <div class="px-8 pb-8">
                        <div class="relative -mt-12 mb-4">
                            <img v-if="selectedContact.avatar" :src="selectedContact.avatar" class="w-24 h-24 rounded-3xl border-4 border-[#0f172a] object-cover bg-slate-800">
                            <div v-else class="w-24 h-24 rounded-3xl border-4 border-[#0f172a] bg-blue-600 flex items-center justify-center text-3xl font-black shadow-lg">
                                {{ selectedContact.username[0] }}
                            </div>
                        </div>

                        <h2 class="text-2xl font-black tracking-tight text-white italic">@{{ selectedContact.username }}</h2>
                        
                        <div class="mt-6 space-y-4">
                            <div>
                                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">√Ä propos</label>
                                <p class="text-sm text-slate-300 leading-relaxed bg-white/5 p-4 rounded-2xl italic">
                                    {{ selectedContact.bio || "Cet utilisateur n'a pas encore r√©dig√© de bio." }}
                                </p>
                            </div>
                        </div>

                        <button @click="showContactProfile = false" class="w-full mt-8 bg-white/5 hover:bg-white/10 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex-1 flex flex-col bg-white/[0.01]">
                <div v-if="selectedContact" class="flex-1 flex flex-col min-h-0">
                    <header class="h-24 flex items-center justify-between px-8 border-b border-white/5 bg-black/10">
                        <div @click="showContactProfile = true" class="flex items-center gap-4 cursor-pointer group">
                            <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center font-bold overflow-hidden shadow-lg group-hover:scale-105 transition-transform">
                                <img v-if="selectedContact.avatar" :src="selectedContact.avatar" class="w-full h-full object-cover">
                                <span v-else>{{ selectedContact.username[0] }}</span>
                            </div>
                            
                            <div class="flex flex-col">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold tracking-tight text-lg group-hover:text-blue-400 transition-colors">{{ selectedContact.username }}</span>
                                </div>
                            </div>
                        </div>
                    
                    </header>
                                        
                    <div ref="msgContainer" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                        <div v-for="m in messages" :key="m.id" :class="m.senderId === user.uid ? 'justify-end' : 'justify-start'" class="flex mb-2 group">
                            <div @dblclick="toggleReaction(m)" 
                                :class="m.senderId === user.uid ? 'bg-blue-600' : 'bg-slate-800'" 
                                class="p-3 px-4 max-w-[75%] rounded-2xl shadow-md relative cursor-pointer select-none">
                                
                                <p class="text-sm leading-relaxed">{{ m.text }}</p>
                                
                                <div v-if="m.reactions && m.reactions.length > 0" 
                                    class="absolute -bottom-2 right-2 bg-slate-700 border border-white/10 rounded-full px-2 py-0.5 flex items-center gap-1 shadow-lg hover:scale-110 transition-transform">
                                    <span class="text-[10px]">üëç</span>
                                    <span v-if="m.reactions.length > 1" class="text-[9px] font-bold text-white/80">
                                        {{ m.reactions.length }}
                                    </span>
                                </div>

                                <div class="flex items-center justify-end gap-2 mt-1">
                                    <span v-if="m.edited" class="text-[8px] text-white/30 italic">modifi√©</span>
                                    
                                    <span class="text-[9px] text-white/50">
                                        {{ m.createdAt ? new Date(m.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...' }}
                                    </span>

                                    <div v-if="m.senderId === user.uid" class="flex gap-2 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click.stop="editMessage(m)" class="text-slate-400 hover:text-blue-400">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                        </button>
                                        <button @click.stop="deleteMessage(m.id)" class="text-slate-400 hover:text-red-400">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 relative">
                        <div v-show="showEmojiPicker" id="emoji-picker-container" class="absolute bottom-24 right-6"></div>

                        <div class="bg-white/5 border border-white/10 rounded-3xl flex items-center pr-3 focus-within:border-blue-500 transition-all">
                            <button @click="toggleEmojiPicker" type="button" class="pl-5 text-slate-400 hover:text-yellow-400 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>

                            <input v-model="newMessage" 
                                @keyup.enter="sendMessage" 
                                @focus="showEmojiPicker = false"
                                placeholder="Message..." 
                                class="bg-transparent flex-1 p-5 outline-none">
                            
                            <button @click="sendMessage" class="p-3 bg-blue-600 rounded-2xl hover:bg-blue-500 transition shadow-lg shadow-blue-900/40">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M5 12h14M12 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div v-else class="flex-1 flex items-center justify-center text-slate-600 italic">
                    S√©lectionnez un contact pour chatter
                </div>
            </div>
        </template>
    </div>
</body>
</html>
